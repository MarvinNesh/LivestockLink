{% extends "base.html" %}

{% block styles %}
{{ super() }}
<!-- Font Awesome CSS CDN (avoids CORS issues) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-pO1B9QZ2qXVk/2LxvJR0ZGx9MZ2oVQfZ6cZ9vGJZrX0rCz5/4o0IhXQxKXf8nK0tP0Z0kl5sO8D0x9cGp1+3Ug==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
    .chat-container {
        max-width: 800px;
        margin: 2rem auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 70vh;
        background-color: #f9f9f9;
    }

    .chat-header {
        background-color: #28a745;
        color: white;
        padding: 1rem;
        text-align: center;
        font-size: 1.25rem;
    }

    .chat-box {
        flex-grow: 1;
        padding: 1rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .chat-message {
        padding: 0.75rem 1rem;
        border-radius: 18px;
        margin-bottom: 0.5rem;
        max-width: 70%;
        line-height: 1.4;
    }

    .user-message {
        background-color: #007bff;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
    }

    .bot-message {
        background-color: #e9ecef;
        color: #333;
        align-self: flex-start;
        border-bottom-left-radius: 4px;
    }
    
    .typing-indicator {
        align-self: flex-start;
        color: #6c757d;
        font-style: italic;
    }

    .chat-input-form {
        display: flex;
        padding: 1rem;
        border-top: 1px solid #ddd;
        background-color: #fff;
    }

    .chat-input {
        flex-grow: 1;
        border: 1px solid #ccc;
        border-radius: 20px;
        padding: 0.5rem 1rem;
        margin-right: 0.5rem;
    }

    .send-btn {
        border-radius: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="chat-container">
        <div class="chat-header">
            <i class="fas fa-tractor"></i> AgriBot - Your Farming Assistant
        </div>
        <div class="chat-box" id="chat-box">
            <div class="chat-message bot-message">
                Hello! I'm AgriBot. How can I help you with your farming questions today?
            </div>
        </div>
        <form class="chat-input-form" id="chat-form">
            <input type="text" class="form-control chat-input" id="user-input" placeholder="Ask a question about farming..." autocomplete="off">
            <button type="submit" class="btn btn-primary send-btn">Send</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const chatBox = document.getElementById('chat-box');

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = userInput.value.trim();
        if (!message) return;

        appendMessage(message, 'user');
        userInput.value = '';
        showTypingIndicator();

        try {
            const response = await fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
            });

            const data = await response.json();
            removeTypingIndicator();

            if (!response.ok) {
                throw new Error(data.error || 'Network response was not ok');
            }

            appendMessage(data.reply, 'bot');

        } catch (error) {
            console.error(error);
            removeTypingIndicator();
            appendMessage('Sorry, something went wrong. Please try again.', 'bot', true);
        }
    });

    function appendMessage(message, sender, isError = false) {
        const msgEl = document.createElement('div');
        msgEl.classList.add('chat-message', sender === 'user' ? 'user-message' : 'bot-message');
        if (isError) msgEl.style.color = 'red';

        let formatted = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        formatted = formatted.replace(/^\* (.*$)/gm, '<ul><li>$1</li></ul>');
        formatted = formatted.replace(/<\/ul>\n<ul>/g, '');

        msgEl.innerHTML = formatted;
        chatBox.appendChild(msgEl);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showTypingIndicator() {
        const typing = document.createElement('div');
        typing.id = 'typing-indicator';
        typing.classList.add('chat-message', 'typing-indicator');
        typing.textContent = 'AgriBot is typing...';
        chatBox.appendChild(typing);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function removeTypingIndicator() {
        const typing = document.getElementById('typing-indicator');
        if (typing) typing.remove();
    }
});
</script>
{% endblock %}
